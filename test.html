<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>FPS — Polished Single-File (Hybrid)</title>
  <style>
    html,body{height:100%;margin:0;background:#0d1117;color:#fff;font-family:Inter,system-ui,Arial;overflow:hidden}
    #hud{position:fixed;left:12px;top:12px;z-index:60}
    .btn{background:#121212;border:1px solid rgba(255,255,255,0.06);padding:8px 10px;border-radius:8px;margin-right:8px;cursor:pointer}
    #crosshair{position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);z-index:60;pointer-events:none;font-size:28px;opacity:0.95}
    #overlay{position:fixed;right:12px;top:12px;z-index:60;text-align:right}
    #instructions{position:fixed;left:50%;bottom:12px;transform:translateX(-50%);opacity:0.85;z-index:60}
    canvas{display:block}
    #message{position:fixed;left:50%;top:40%;transform:translateX(-50%);padding:16px 22px;background:rgba(0,0,0,0.6);border-radius:8px;z-index:70}
    #weapon{position:fixed;right:10%;bottom:8%;z-index:65;width:280px;height:160px;pointer-events:none;opacity:0.95}
    .pickup{background:rgba(255,255,255,0.03);padding:6px;border-radius:6px;margin-top:6px}
  </style>
</head>
<body>
  <div id="hud">
    <button id="startBtn" class="btn">Start (Click to lock)</button>
    <button id="resetBtn" class="btn">Reset</button>
    <div id="score">Score: 0</div>
    <div id="hp">HP: 100</div>
    <div id="ammo">Ammo: 30</div>
  </div>
  <div id="crosshair">+</div>
  <div id="instructions">WASD move • Mouse look • Left-click shoot • Space jump • Shift sprint • R reload</div>
  <div id="message" style="display:block">Click Start and allow pointer lock to play.</div>
  <canvas id="overlayCanvas" width="512" height="256" style="display:none"></canvas>

  <script src="https://unpkg.com/three@0.155.0/build/three.min.js"></script>
  <script>
  let scene, camera, renderer;
  const objects = [];
  const enemies = [];
  const pickups = [];
  const particles = [];

  const world = { gravity: -35, groundY: 0 };
  const player = { pos: {x:0,y:0,z:8}, height:1.7, velocity:{x:0,y:0,z:0}, speed:7.2, sprintMult:1.6, onGround:true, coyote:0, jumpPower:10.5, hp:100, ammo:90, score:0, recoil:0 };
  const move = {f:0,b:0,l:0,r:0,sprint:false};
  let yaw=0, pitch=0, pointerLocked=false;

  const weapon = { mag:30, reserve:60, fireRate:0.12, lastShot:-10, reloadTime:1.2, reloading:false };
  const clock = new THREE.Clock(false);

  init(); resetLevel(); animate();

  function init(){
    renderer = new THREE.WebGLRenderer({antialias:true});
    renderer.setPixelRatio(window.devicePixelRatio);
    renderer.setSize(window.innerWidth, window.innerHeight);
    document.body.appendChild(renderer.domElement);

    scene = new THREE.Scene();
    scene.background = new THREE.Color(0x94b2ff);
    camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);

    const hemi = new THREE.HemisphereLight(0xffffff,0x444466,0.8); scene.add(hemi);
    const dir = new THREE.DirectionalLight(0xffffff,0.6); dir.position.set(10,20,10); scene.add(dir);

    const floor = new THREE.Mesh(new THREE.BoxGeometry(400,2,400), new THREE.MeshStandardMaterial({color:0x44484f}));
    floor.position.y=-1; scene.add(floor); objects.push(floor);

    const wallM = new THREE.MeshStandardMaterial({color:0x2f3337});
    [[0,9,-200,400,20,4],[0,9,200,400,20,4],[-200,9,0,4,20,400],[200,9,0,4,20,400]].forEach(d=>{const w=new THREE.Mesh(new THREE.BoxGeometry(d[3],d[4],d[5]), wallM); w.position.set(d[0],d[1],d[2]); scene.add(w); objects.push(w);});

    for(let i=0;i<18;i++){ const b=new THREE.Mesh(new THREE.BoxGeometry(4,4,4), new THREE.MeshStandardMaterial({color:0x6b4f2b})); b.position.set((Math.random()-0.5)*120,2,(Math.random()-0.5)*120); scene.add(b); objects.push(b); }

    createWeaponModel();

    for(let i=0;i<8;i++) spawnEnemy({x:(Math.random()-0.5)*120,y:1,z:(Math.random()-0.5)*120-40});
    for(let i=0;i<6;i++) spawnPickup({x:(Math.random()-0.5)*120,y:0.5,z:(Math.random()-0.5)*120});

    document.getElementById('startBtn').addEventListener('click', ()=>{ renderer.domElement.requestPointerLock(); });
    document.getElementById('resetBtn').addEventListener('click', resetLevel);

    document.addEventListener('pointerlockchange', ()=>{ pointerLocked=document.pointerLockElement===renderer.domElement; document.getElementById('message').style.display=pointerLocked?'none':'block'; });
    document.addEventListener('mousemove', e=>{ if(!pointerLocked) return; yaw-=e.movementX*0.0022; pitch-=e.movementY*0.0022; pitch=Math.max(-Math.PI/2+0.05,Math.min(Math.PI/2-0.05,pitch)); });
    document.addEventListener('keydown', onKeyDown); document.addEventListener('keyup', onKeyUp);
    document.addEventListener('mousedown', e=>{ if(pointerLocked && e.button===0) doShoot(); });
    window.addEventListener('resize', ()=>{ camera.aspect=window.innerWidth/window.innerHeight; camera.updateProjectionMatrix(); renderer.setSize(window.innerWidth,window.innerHeight); });
  }

  function createWeaponModel(){ const group=new THREE.Group(); group.name='weapon'; const body=new THREE.Mesh(new THREE.BoxGeometry(0.9,0.6,2.2), new THREE.MeshStandardMaterial({color:0x222222})); body.position.set(0,-0.25,-1.1); const barrel=new THREE.Mesh(new THREE.BoxGeometry(0.2,0.2,0.9), new THREE.MeshStandardMaterial({color:0x111111})); barrel.position.set(0,-0.1,-2.1); group.add(body); group.add(barrel); scene.add(group); }

  function onKeyDown(e){ if(e.code==='KeyW') move.f=1;if(e.code==='KeyS') move.b=1;if(e.code==='KeyA') move.l=1;if(e.code==='KeyD') move.r=1;if(e.code==='ShiftLeft') move.sprint=true;if(e.code==='Space'){if(player.coyote>0||player.onGround){player.velocity.y=player.jumpPower;player.onGround=false;player.coyote=0;}}if(e.code==='KeyR') doReload();if(e.code==='KeyE') tryPickup();}
  function onKeyUp(e){ if(e.code==='KeyW') move.f=0;if(e.code==='KeyS') move.b=0;if(e.code==='KeyA') move.l=0;if(e.code==='KeyD') move.r=0;if(e.code==='ShiftLeft') move.sprint=false; }

  function doShoot(){ if(weapon.reloading) return; const now=performance.now()/1000; if(now-weapon.lastShot<weapon.fireRate) return; if(weapon.mag<=0){weapon.lastShot=now;return;} weapon.mag--; weapon.lastShot=now; player.recoil=Math.min(1.6,player.recoil+0.35); document.getElementById('ammo').innerText='Ammo: '+weapon.mag+' / '+weapon.reserve; }
  function doReload(){ if(weapon.reloading || weapon.reserve<=0 || weapon.mag>=30) return; weapon.reloading=true; setTimeout(()=>{ const need=30-weapon.mag; const take=Math.min(need,weapon.reserve); weapon.mag+=take; weapon.reserve-=take; weapon.reloading=false; document.getElementById('ammo').innerText='Ammo: '+weapon.mag+' / '+weapon.reserve; }, weapon.reloadTime*1000); }

  function tryPickup(){ let nearest=null; let nd=Infinity; for(const p of pickups){ const d=new THREE.Vector3(p.mesh.position.x-player.pos.x,0,p.mesh.position.z-player.pos.z).length(); if(d<nd){ nd=d; nearest=p; } } if(nearest && nd<3){ applyPickup(nearest); } }
  function applyPickup(p){ if(p.type==='health'){player.hp=Math.min(100,player.hp+35);document.getElementById('hp').innerText='HP: '+Math.floor(player.hp);} if(p.type==='ammo'){weapon.reserve+=20;document.getElementById('ammo').innerText='Ammo: '+weapon.mag+' / '+weapon.reserve;} scene.remove(p.mesh); pickups.splice(pickups.indexOf(p),1); }

  function spawnPickup(pos){ const geom=new THREE.BoxGeometry(0.7,0.7,0.7); const mat=new THREE.MeshStandardMaterial({color:Math.random()>0.5?0x66ff88:0x88ccff}); const m=new THREE.Mesh(geom,mat); m.position.set(pos.x,pos.y,pos.z); scene.add(m); pickups.push({mesh:m,type:Math.random()>0.5?'health':'ammo'}); }
  function spawnEnemy(pos){ const geom=new THREE.CapsuleGeometry(0.6,0.8,4,8); const mat=new THREE.MeshStandardMaterial({color:0xff6666}); const m=new THREE.Mesh(geom,mat); m.position.set(pos.x,pos.y,pos.z); scene.add(m); enemies.push({mesh:m,hp:100,speed:1.2+Math.random()*0.6}); }

  function resetLevel(){ player.pos={x:0,y:0,z:8}; player.velocity={x:0,y:0,z:0}; player.hp=100; player.score=0; player.recoil=0; player.onGround=true; player.coyote=0; weapon.mag=30; weapon.reserve=60; weapon.reloading=false; weapon.lastShot=-10; document.getElementById('hp').innerText='HP: '+player.hp; document.getElementById('ammo').innerText='Ammo: '+weapon.mag+' / '+weapon.reserve; document.getElementById('score').innerText='Score: '+player.score; enemies.forEach(e=>scene.remove(e.mesh)); enemies.length=0; pickups.forEach(p=>scene.remove(p.mesh)); pickups.length=0; particles.forEach(p=>scene.remove(p.mesh)); particles.length=0; for(let i=0;i<10;i++) spawnEnemy({x:(Math.random()-0.5)*100,y:1,z:(Math.random()-0.5)*100-20}); for(let i=0;i<8;i++) spawnPickup({x:(Math.random()-0.5)*100,y:0.5,z:(Math.random()-0.5)*100}); yaw=0; pitch=0; updateCameraTransform(true); }

  function updateCameraTransform(force=false){ camera.position.set(player.pos.x, player.pos.y+player.height, player.pos.z); const recoilPitch=-player.recoil*0.3; const rx=pitch+recoilPitch; const dir=new THREE.Vector3(Math.cos(yaw)*Math.cos(rx), Math.sin(rx), Math.sin(yaw)*Math.cos(rx)); const target=new THREE.Vector3(player.pos.x+dir.x, player.pos.y+player.height+dir.y, player.pos.z+dir.z); camera.lookAt(target); const weaponModel=scene.getObjectByName('weapon'); if(weaponModel){ const bob=(Math.sin(performance.now()*0.006)*0.02)*(move.f||move.b||move.l||move.r?1:0); weaponModel.position.copy(camera.position); weaponModel.position.add(new THREE.Vector3(-Math.sin(yaw)*0.35,-0.45+bob,-0.75)); weaponModel.rotation.set(-rx*0.2+player.recoil*0.08,yaw*0.2+player.recoil*0.02,player.recoil*0.02); weaponModel.name='weapon'; } }

  function simulate(dt){ const input=new THREE.Vector3(move.r-move.l,0,move.b-move.f); let moveDir=new THREE.Vector3(); if(input.x!==0||input.z!==0){ const forward=new THREE.Vector3(Math.cos(yaw),0,Math.sin(yaw)); const right=new THREE.Vector3(Math.cos(yaw+Math.PI/2),0,Math.sin(yaw+Math.PI/2)); moveDir.add(forward.clone().multiplyScalar(-input.z)); moveDir.add(right.clone().multiplyScalar(input.x)); moveDir.normalize(); }
    const speedNow=player.speed*(move.sprint?player.sprintMult:1); player.velocity.x=moveDir.x*speedNow; player.velocity.z=moveDir.z*speedNow; player.velocity.y+=world.gravity*dt; player.pos.x+=player.velocity.x*dt; player.pos.y+=player.velocity.y*dt; player.pos.z+=player.velocity.z*dt;
    if(player.pos.y<=world.groundY){ if(!player.onGround) player.coyote=0.12; player.pos.y=world.groundY; player.velocity.y=0; player.onGround=true;} else {player.onGround=false; player.coyote-=dt;}
    const pBox=new THREE.Box3(new THREE.Vector3(player.pos.x-0.25,player.pos.y,player.pos.z-0.25), new THREE.Vector3(player.pos.x+0.25,player.pos.y+player.height,player.pos.z+0.25)); for(const obj of objects){ const box=new THREE.Box3().setFromObject(obj); if(box.intersectsBox(pBox)){ player.pos.x-=player.velocity.x*dt*1.1; player.pos.z-=player.velocity.z*dt*1.1; player.velocity.x=0; player.velocity.z=0; } }
    enemies.forEach(en=>{ const dir=new THREE.Vector3(player.pos.x-en.mesh.position.x,0,player.pos.z-en.mesh.position.z); const dist=dir.length(); if(dist>1.2){ dir.normalize(); en.mesh.position.x+=dir.x*en.speed*dt; en.mesh.position.z+=dir.z*en.speed*dt;} if(dist<1.6){ player.hp-=12*dt; document.getElementById('hp').innerText=Math.max(0,Math.floor(player.hp)); if(player.hp<=0) loseGame(); } });
    for(let i=pickups.length-1;i>=0;i--){ const p=pickups[i]; const d=new THREE.Vector3(p.mesh.position.x-player.pos.x,0,p.mesh.position.z-player.pos.z).length(); if(d<1.2){ applyPickup(p); }}
    for(let i=particles.length-1;i>=0;i--){ particles[i].life-=dt; if(particles[i].life<=0){ scene.remove(particles[i].mesh); particles.splice(i,1); } }
    player.recoil=Math.max(0,player.recoil-dt*1.6); }

  function animate(){ requestAnimationFrame(animate); const dt=Math.min(clock.getDelta(),0.06); if(pointerLocked) simulate(dt); updateCameraTransform(); pickups.forEach(p=>{p.mesh.rotation.y+=0.02;}); renderer.render(scene,camera); }
  function loseGame(){ document.getElementById('message').innerText='You died — press Reset to try again'; document.getElementById('message').style.display='block'; if(document.exitPointerLock) document.exitPointerLock(); }
  </script>
</body>
</html>
