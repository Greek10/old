<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Clash Royale Clone (Final Enhanced Version)</title>
    <style>
        body { display: flex; justify-content: center; align-items: center; background-color: #333; margin: 0; height: 100vh; font-family: sans-serif; }
        #game-container { width: 800px; height: 600px; background-color: #4CAF50; position: relative; border: 2px solid #000; overflow: hidden; }
        #river { position: absolute; top: 50%; left: 0; right: 0; height: 40px; background-color: #2196F3; transform: translateY(-50%); border-top: 2px solid #000; border-bottom: 2px solid #000; }
        #ui-bar { position: absolute; bottom: 0; left: 0; right: 0; height: 100px; background-color: #555; display: flex; justify-content: space-around; align-items: center; }
        .card-slot { width: 70px; height: 90px; background-color: #eee; border: 2px solid #000; cursor: pointer; text-align: center; padding-top: 5px; box-sizing: border-box; user-select: none; position: relative; transition: background-color 0.1s; }
        .card-slot:hover:not(.disabled) { background-color: #fff; }
        .card-slot.disabled { opacity: 0.5; cursor: not-allowed; background-color: #aaa; }
        .elixir-cost { position: absolute; bottom: 5px; right: 5px; background: #f44336; color: white; border-radius: 50%; width: 20px; height: 20px; display: flex; justify-content: center; align-items: center; font-size: 14px; }

        .unit { position: absolute; box-sizing: border-box; display: flex; flex-direction: column; align-items: center; }
        .troop { width: 30px; height: 40px; border-radius: 50%; }
        .tower { width: 60px; height: 80px; }
        .tower.player { background-color: lightblue; border: 2px solid blue; }
        .tower.enemy { background-color: lightcoral; border: 2px solid red; }
        .tower.king { background-color: gold; border-color: #DAA520; }

        .health-bar { width: 100%; height: 5px; background-color: grey; margin-bottom: 2px; }
        .health-bar-inner { height: 100%; background-color: green; transition: width 0.1s linear; }

        /* Effects Styles */
        .projectile { position: absolute; width: 10px; height: 10px; background-color: yellow; border-radius: 50%; pointer-events: none; transition: transform 0.05s ease-out; }
        .effect-explosion { position: absolute; width: 50px; height: 50px; background-color: orange; border-radius: 50%; opacity: 0; transform: scale(0); animation: explode 0.3s forwards; pointer-events: none; }
        @keyframes explode { 0% { opacity: 1; transform: scale(0); } 100% { opacity: 0; transform: scale(1.5); } }

        #elixir-bar-container { position: absolute; bottom: 110px; left: 20px; width: 200px; height: 20px; background-color: black; border: 2px solid white; }
        #elixir-bar { height: 100%; width: 0%; background-color: purple; transition: width 0.1s linear; }
        #elixir-count { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: white; font-weight: bold; }
        #game-message { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 36px; color: white; text-shadow: 2px 2px 4px #000000; display: none; z-index: 10; }
    </style>
</head>
<body>
    <div id="game-container">
        <div id="river"></div>
        <div id="game-message"></div>
        
        <div id="elixir-bar-container">
            <div id="elixir-bar"></div>
            <span id="elixir-count">0 / 10</span>
        </div>

        <div id="ui-bar">
            <div id="card-1" class="card-slot" onclick="deployTroop(1)">Knight <span class="elixir-cost">3</span></div>
            <div id="card-2" class="card-slot" onclick="deployTroop(2)">Archer <span class="elixir-cost">4</span></div>
            <div id="card-3" class="card-slot" onclick="deployTroop(3)">Giant <span class="elixir-cost">5</span></div>
        </div>
    </div>
    
    <script>
        const gameContainer = document.getElementById('game-container');
        const elixirBar = document.getElementById('elixir-bar');
        const elixirCountEl = document.getElementById('elixir-count');
        const gameMessageEl = document.getElementById('game-message');
        const ARENA_HEIGHT = 500; 
        const TROOP_RADIUS = 15;

        let unitId = 0;
        const activeUnits = [];
        let playerElixir = 0;
        const MAX_ELIXIR = 10;
        const ELIXIR_RATE = 1000; 

        const TROOP_STATS = {
            1: { name: 'Knight', hp: 500, speed: 2, cost: 3, dmg: 75, range: 40, attackSpeed: 1000, color: 'blue' },
            2: { name: 'Archer', hp: 200, speed: 3, cost: 4, dmg: 50, range: 180, attackSpeed: 800, color: 'lightblue' },
            3: { name: 'Giant', hp: 1200, speed: 1, cost: 5, dmg: 100, range: 40, attackSpeed: 1500, color: 'darkblue' },
        };
        const TOWER_STATS = { hp: 2000, dmg: 80, range: 250, attackSpeed: 900, speed: 0 };
        const KING_TOWER_STATS = { hp: 3000, dmg: 100, range: 250, attackSpeed: 1000, speed: 0 };


        // --- Effects ---
        function createExplosion(x, y) {
            const effectEl = document.createElement('div');
            effectEl.classList.add('effect-explosion');
            effectEl.style.left = `${x - 25}px`;
            effectEl.style.top = `${y - 25}px`;
            gameContainer.appendChild(effectEl);
            setTimeout(() => effectEl.remove(), 300);
        }

        function launchProjectile(shooter, target) {
            const projectile = document.createElement('div');
            projectile.classList.add('projectile');
            gameContainer.appendChild(projectile);

            // Set initial position to center of shooter
            projectile.style.left = `${shooter.x}px`;
            projectile.style.top = `${shooter.y}px`;

            const interval = setInterval(() => {
                if (!target || target.hp <= 0 || !document.body.contains(projectile)) {
                    clearInterval(interval);
                    projectile.remove();
                    return;
                }

                const speed = 15; // Fast projectiles
                const angle = Math.atan2(target.y - parseFloat(projectile.style.top), target.x - parseFloat(projectile.style.left));
                
                projectile.style.left = `${parseFloat(projectile.style.left) + Math.cos(angle) * speed}px`;
                projectile.style.top = `${parseFloat(projectile.style.top) + Math.sin(angle) * speed}px`;

                // Check for hit
                if (getDistance({x: parseFloat(projectile.style.left), y: parseFloat(projectile.style.top)}, {x: target.x, y: target.y}) < 20) {
                    clearInterval(interval);
                    applyDamage(target, shooter.dmg);
                    projectile.remove();
                }
            }, 16); // Faster interval for smoother movement
        }

        function applyDamage(target, amount) {
            target.hp -= amount;
            if (target.healthBar) {
                const hpPercent = (target.hp / target.maxHp) * 100;
                target.healthBar.style.width = `${Math.max(0, hpPercent)}%`;
            }
            if (target.hp <= 0 && target.element) {
                createExplosion(target.x, target.y);
            }
        }

        // --- Unit Creation & Management ---
        function createHealthBar(unitData) {
            const healthBar = document.createElement('div');
            healthBar.classList.add('health-bar');
            const healthBarInner = document.createElement('div');
            healthBarInner.classList.add('health-bar-inner');
            healthBar.appendChild(healthBarInner);
            unitData.healthBar = healthBarInner;
            return healthBar;
        }

        function createUnit(type, isPlayer, x, y, unitClass = 'troop') {
            const isTower = unitClass.includes('tower');
            const isKing = unitClass.includes('king');
            const stats = isKing ? KING_TOWER_STATS : (isTower ? TOWER_STATS : TROOP_STATS[type]);
            
            const unitEl = document.createElement('div');
            unitEl.classList.add('unit', unitClass);
            unitEl.classList.add(isPlayer ? 'player' : 'enemy');

            if (unitClass === 'troop') unitEl.style.backgroundColor = stats.color;

            // Positioning logic for center point (x, y)
            const width = isTower ? 60 : 30;
            const height = isTower ? 80 : 40;
            unitEl.style.left = `${x - width / 2}px`;
            unitEl.style.top = `${y - height / 2}px`;

            const unitData = {
                id: unitId++,
                type: type,
                element: unitEl,
                x: x,
                y: y,
                hp: stats.hp,
                maxHp: stats.hp,
                speed: stats.speed || 0,
                dmg: stats.dmg,
                range: stats.range,
                attackSpeed: stats.attackSpeed,
                isPlayer: isPlayer,
                isTower: isTower || isKing,
                isKing: isKing,
                target: null,
                attackCooldown: 0,
            };
            
            unitEl.appendChild(createHealthBar(unitData));
            activeUnits.push(unitData);
            gameContainer.appendChild(unitEl);
            return unitData;
        }

        window.deployTroop = function(type) {
            const stats = TROOP_STATS[type];
            if (playerElixir >= stats.cost) {
                // Deploy in player's half, below the river line (Y > 300)
                const startX = Math.random() * (gameContainer.clientWidth - 40) + 20;
                const startY = Math.random() * (ARENA_HEIGHT / 2 - 50) + (ARENA_HEIGHT / 2 + 50);
                createUnit(type, true, startX, startY, 'troop');
                updateElixir(-stats.cost);
            }
        }
        
        // --- Enemy AI ---
        function spawnEnemyTroop() {
            // Deploy in enemy's half, above the river line (Y < 300)
            const startX = Math.random() * (gameContainer.clientWidth - 40) + 20;
            const startY = Math.random() * (ARENA_HEIGHT / 2 - 50) + 50; 
            // Enemy randomly chooses between Knight or Archer type for simplicity
            const type = Math.random() > 0.5 ? 1 : 2; 
            createUnit(type, false, startX, startY, 'troop');
        }
        setInterval(spawnEnemyTroop, 5000); // Deploy enemy every 5 seconds


        // --- Combat & Movement Logic ---
        function getDistance(unit1, unit2) {
            const dx = unit1.x - unit2.x;
            const dy = unit1.y - unit2.y;
            return Math.sqrt(dx * dx + dy * dy);
        }

        function findTarget(unit) {
            let closestTarget = null;
            let minDist = Infinity;

            for (const otherUnit of activeUnits) {
                if (unit.isPlayer !== otherUnit.isPlayer && otherUnit.hp > 0) {
                    const dist = getDistance(unit, otherUnit);
                    // CR Targeting logic: prioritize closest unit/building
                    if (dist < minDist) {
                        minDist = dist;
                        closestTarget = otherUnit;
                    }
                }
            }
            unit.target = closestTarget;
        }

        function handleCombatAndMovement(unit) {
            if (!unit.target || unit.target.hp <= 0) {
                findTarget(unit);
                if (!unit.target) return; // No targets available
            }

            const distanceToTarget = getDistance(unit, unit.target);

            if (distanceToTarget <= unit.range) {
                // Stop moving and attack
                unit.attackCooldown -= 16; 
                if (unit.attackCooldown <= 0) {
                    launchProjectile(unit, unit.target);
                    unit.attackCooldown = unit.attackSpeed; 
                }
            } else if (!unit.isTower) {
                // Move towards target if out of range and not a tower/building
                const angle = Math.atan2(unit.target.y - unit.y, unit.target.x - unit.x);
                unit.x += Math.cos(angle) * unit.speed;
                unit.y += Math.sin(angle) * unit.speed;
            }
        }

        function checkWinLoss() {
            // Win condition: Destroy enemy King Tower
            const enemyKing = activeUnits.find(u => u.isKing && !u.isPlayer);
            if (!enemyKing || enemyKing.hp <= 0) {
                gameMessageEl.textContent = "VICTORY! ðŸŽ‰";
                gameMessageEl.style.display = 'block';
                return true;
            }
            
            // Loss condition: Player King Tower destroyed
            const playerKing = activeUnits.find(u => u.isKing && u.isPlayer);
            if (!playerKing || playerKing.hp <= 0) {
                gameMessageEl.textContent = "DEFEAT! ðŸ’€";
                gameMessageEl.style.display = 'block';
                return true;
            }
            return false;
        }

        // Main game loop
        function updateGame() {
            if (checkWinLoss()) return; 

            // Filter out destroyed units and update logic
            for (let i = activeUnits.length - 1; i >= 0; i--) {
                const unit = activeUnits[i];
                if (unit.hp <= 0) {
                    unit.element.remove();
                    activeUnits.splice(i, 1);
                } else {
                    handleCombatAndMovement(unit);
                    // Update DOM position
                    const width = unit.isTower ? 60 : 30;
                    const height = unit.isTower ? 80 : 40;
                    unit.element.style.left = `${unit.x - width / 2}px`;
                    unit.element.style.top = `${unit.y - height / 2}px`;
                }
            }
            
            requestAnimationFrame(updateGame);
        }

        // Initialization
        document.addEventListener('DOMContentLoaded', (event) => {
            const centerX = gameContainer.clientWidth / 2;

            // Player Towers (King in center, Princess towers on sides)
            createUnit(null, true, centerX, ARENA_HEIGHT - 120, 'tower');
            createUnit(null, true, centerX, ARENA_HEIGHT - 30, 'king tower'); // King tower at very bottom center

            // Enemy Towers
            createUnit(null, false, centerX, 120, 'tower');
            createUnit(null, false, centerX, 30, 'king tower'); // Enemy King tower at very top center

            updateElixir(0); 
            requestAnimationFrame(updateGame);
        });
    </script>
</body>
</html>
