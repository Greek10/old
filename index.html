<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Python Sandbox v5</title>

<!-- Pyodide -->
<script src="https://cdn.jsdelivr.net/pyodide/v0.25.1/full/pyodide.js"></script>

<!-- CodeMirror -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/codemirror.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/mode/python/python.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/addon/hint/show-hint.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/addon/hint/python-hint.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/codemirror.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/theme/dracula.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/addon/hint/show-hint.min.css">

<style>
body {
  margin:0;
  height:100vh;
  display:flex;
  flex-direction:column;
  font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  background:#0f111a;
  color:#fff;
  overflow:hidden;
}

/* Toolbar */
#toolbar {
  background: linear-gradient(90deg, #1e1f2a, #272936);
  padding:8px;
  display:flex;
  align-items:center;
  border-bottom:1px solid #333;
  gap:8px;
  flex-wrap:wrap;
  transition:0.3s;
}

button {
  background:#3a3b4d;
  color:white;
  border:none;
  padding:8px 14px;
  border-radius:8px;
  cursor:pointer;
  font-weight:500;
  transition:0.2s;
}

button:hover { background:#505164; }

#status { margin-left:auto; font-size:14px; color:#bbb; }

#toolbarToggle, #themeBtn {
  background:#2c2d3c;
  border-radius:50%;
  width:30px;
  height:30px;
  text-align:center;
  line-height:30px;
  cursor:pointer;
  font-weight:bold;
  margin-left:5px;
}

/* Theme panel */
#themePanel {
  position:absolute;
  top:50px;
  right:20px;
  background:#222;
  padding:12px;
  border-radius:12px;
  display:none;
  z-index:10;
  border:1px solid #444;
}
#themePanel label { display:block; margin:5px 0 2px; font-size:13px; }
#themePanel input[type=color] { width:100%; height:30px; border:none; cursor:pointer; border-radius:6px; }

/* Sandbox */
#sandbox {
  flex:1;
  display:flex;
  overflow:hidden;
}

/* Editor */
#editor {
  width:35%;
  overflow:auto;
  border-right:5px solid #333;
  transition:width 0.3s;
  min-width:150px;
}

/* Draggable divider */
#divider {
  width:5px;
  cursor:col-resize;
  background:#333;
  transition:background 0.2s;
}
#divider:hover { background:#555; }

/* Output */
#output {
  flex:1;
  overflow:auto;
  background:#0b0b0b;
  padding:12px;
  white-space:pre-wrap;
  font-size:15px;
}

/* Errors */
.error { color:#ff6b6b; cursor:pointer; text-decoration:underline dotted; }

/* Scrollbar */
#output::-webkit-scrollbar, #editor::-webkit-scrollbar { width:10px; }
#output::-webkit-scrollbar-thumb, #editor::-webkit-scrollbar-thumb { background:#444; border-radius:5px; }
#output::-webkit-scrollbar-track, #editor::-webkit-scrollbar-track { background:#1a1a1a; }
</style>
</head>
<body>

<div id="toolbar">
  <button id="run">â–¶ Run</button>
  <button id="runSel">â–¶ Run Selection</button>
  <button id="format">ðŸ§¹ Format</button>
  <button id="loadPkg">ðŸ“¦ Load Package</button>
  <button id="openBtn">ðŸ“‚ Open</button>
  <button id="saveBtn">ðŸ’¾ Save</button>
  <input type="file" id="fileInput" accept=".py">
  <div id="themeBtn">ðŸŽ¨</div>
  <span id="status">Loading...</span>
  <div id="toolbarToggle">âˆ’</div>
</div>

<div id="themePanel">
  <label>Background:</label><input type="color" id="bgColor" value="#0f111a">
  <label>Editor:</label><input type="color" id="editorColor" value="#1e1f2a">
  <label>Output:</label><input type="color" id="outputColor" value="#0b0b0b">
</div>

<div id="sandbox">
  <div id="editor"></div>
  <div id="divider"></div>
  <pre id="output">Loading Pyodide...</pre>
</div>

<script>
let pyodide;
const output = document.getElementById("output");
const status = document.getElementById("status");

// --- CodeMirror ---
const editor = CodeMirror(document.getElementById("editor"), {
  value:'print("Hello, world!")',
  mode:'python',
  theme:'dracula',
  lineNumbers:true,
  indentUnit:4,
  extraKeys: { "Tab": cm => cm.replaceSelection(" ".repeat(4)), "Ctrl-Enter": ()=>runCode(), "Ctrl-Space": "autocomplete" }
});

// --- Output helper ---
function printOut(text){ output.textContent += text + "\n"; output.scrollTop = output.scrollHeight; }

// --- Error helper ---
function showError(err){
  const msg = err.toString();
  const lineMatch = msg.match(/line (\d+)/);
  if(lineMatch){
    const line = parseInt(lineMatch[1]);
    const span = document.createElement("span");
    span.textContent = msg;
    span.className = "error";
    span.onclick = ()=>editor.setCursor(line-1);
    output.appendChild(span);
  } else printOut(msg);
  printOut("");
}

// --- Load Pyodide ---
async function init(){
  pyodide = await loadPyodide();
  await pyodide.loadPackage(["micropip"]);
  pyodide.globals.set("printOut", printOut);
  pyodide.globals.set("getInput", ()=>prompt("Input:")||"");
  await pyodide.runPythonAsync(`
import sys
from pyodide.ffi import create_proxy
import builtins

printOut = create_proxy(printOut)
getInput = create_proxy(getInput)

class JSWriter:
    def write(self,s):
        if s.strip()!="": printOut(s)
    def flush(self): pass

sys.stdout = JSWriter()
sys.stderr = JSWriter()
builtins.input = lambda prompt='': getInput()
`);
  output.textContent = "Pyodide loaded. Input() and auto-completion ready.\n";
}
init();

// --- Run code ---
async function runCode(code=editor.getValue()){
  if(!pyodide) return;
  output.textContent="";
  status.textContent="Running...";
  try{ const result = await pyodide.runPythonAsync(code); if(result!==undefined) printOut(result.toString()); }
  catch(err){ showError(err); }
  status.textContent="";
}

// --- Run selection ---
document.getElementById("runSel").onclick = ()=>{ const sel=editor.getSelection(); if(sel.trim()) runCode(sel); else runCode(); };
document.getElementById("run").onclick = ()=>runCode();

// --- Format code ---
document.getElementById("format").onclick = async ()=>{
  if(!pyodide) return;
  try{
    await pyodide.runPythonAsync(`import micropip; await micropip.install("black")`);
    const code=editor.getValue();
    const formatted=await pyodide.runPythonAsync(`
from black import format_str, FileMode
format_str("""${code.replace(/`/g,"\\`")}""", mode=FileMode())
`);
    editor.setValue(formatted);
  } catch(e){ printOut("Formatter error: "+e); }
};

// --- Load package ---
document.getElementById("loadPkg").onclick=async ()=>{
  const pkg=prompt("Enter package name to install (PyPI):");
  if(!pkg) return;
  try{ await pyodide.runPythonAsync(`import micropip; await micropip.install("${pkg}")`); printOut(`âœ… Package "${pkg}" installed`); }
  catch(e){ printOut(`âŒ Failed: ${e}`); }
};

// --- File upload/download ---
document.getElementById("openBtn").onclick = ()=>document.getElementById("fileInput").click();
document.getElementById("fileInput").onchange=e=>{ e.target.files[0].text().then(txt=>editor.setValue(txt)); };
document.getElementById("saveBtn").onclick=()=>{ const blob=new Blob([editor.getValue()],{type:"text/plain"}); const a=document.createElement("a"); a.href=URL.createObjectURL(blob); a.download="script.py"; a.click(); };

// --- Toolbar toggle ---
const toolbar=document.getElementById("toolbar");
const toggle=document.getElementById("toolbarToggle");
let collapsed=false;
toggle.onclick=()=>{
  collapsed=!collapsed;
  if(collapsed){ toolbar.style.display="none"; } else { toolbar.style.display="flex"; }
};

// --- Theme panel ---
const themePanel=document.getElementById("themePanel");
document.getElementById("themeBtn").onclick=()=>{ themePanel.style.display = themePanel.style.display==="block"?"none":"block"; };
document.getElementById("bgColor").oninput=e=>document.body.style.background=e.target.value;
document.getElementById("editorColor").oninput=e=>editor.getWrapperElement().style.background=e.target.value;
document.getElementById("outputColor").oninput=e=>output.style.background=e.target.value;

// --- Resizable editor/output ---
const divider=document.getElementById("divider");
let isResizing=false;
divider.addEventListener("mousedown",()=>isResizing=true);
document.addEventListener("mousemove",e=>{
  if(!isResizing) return;
  let newWidth=e.clientX;
  if(newWidth<150) newWidth=150;
  if(newWidth>window.innerWidth-150) newWidth=window.innerWidth-150;
  document.getElementById("editor").style.width=newWidth+"px";
});
document.addEventListener("mouseup",()=>isResizing=false);
</script>
</body>
</html>
