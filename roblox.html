<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Roblox Neon Lookup</title>

<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@500;700&family=Inter:wght@400;600&display=swap" rel="stylesheet">

<style>
:root {
  --bg: #04050f;
  --panel: rgba(255,255,255,0.06);
}
*{box-sizing:border-box;}
body{
  margin:0;
  font-family:'Inter',system-ui,sans-serif;
  background:radial-gradient(circle at 15% 20%, rgba(255,46,212,0.2), transparent 30%),
             radial-gradient(circle at 80% 0%, rgba(0,255,247,0.18), transparent 32%),
             radial-gradient(circle at 45% 75%, rgba(130,86,255,0.18), transparent 38%),
             var(--bg);
  color:#e8f7ff;
  min-height:100vh;
  padding:20px;
}
h1{
  font-family:'Orbitron',sans-serif;
  text-align:center;
  letter-spacing:1.2px;
}
.container{
  max-width:980px;
  margin:auto;
}
.controls{
  display:flex;
  gap:10px;
  margin:20px 0;
  flex-wrap:wrap;
}
input{
  flex:1;
  min-width:200px;
  padding:10px 12px;
  border-radius:12px;
  border:1px solid rgba(255,255,255,0.12);
  background:rgba(255,255,255,0.05);
  color:white;
}
button{
  padding:10px 16px;
  border-radius:12px;
  border:1px solid rgba(0,255,255,0.4);
  background:rgba(0,255,255,0.18);
  color:white;
  font-weight:600;
  cursor:pointer;
  text-shadow:0 0 10px rgba(0,255,255,0.5);
  transition:0.18s;
}
button:hover{
  background:rgba(0,255,255,0.3);
  box-shadow:0 0 20px rgba(0,255,255,0.35);
}
.grid{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(230px,1fr));
  gap:14px;
}
.card{
  background:var(--panel);
  border:1px solid rgba(255,255,255,0.14);
  border-radius:14px;
  padding:14px;
  box-shadow:0 12px 30px rgba(0,0,0,0.45),0 0 18px rgba(0,255,255,0.2);
}
.card h3{margin-top:0;}

/* Popup */
#popupOverlay{
  position:fixed;
  inset:0;
  display:none;
  justify-content:center;
  align-items:center;
  background:rgba(0,0,0,0.65);
  backdrop-filter:blur(6px);
  z-index:100;
}
.popup-box{
  background:rgba(8,12,26,0.95);
  border:1px solid rgba(0,255,255,0.4);
  border-radius:14px;
  padding:18px;
  width:90%;
  max-width:620px;
  max-height:72vh;
  overflow:auto;
  color:white;
  box-shadow:0 0 30px rgba(0,255,255,0.3);
}
.popup-box h2{margin-top:0;}

.clickable-item {
  cursor:pointer;
  padding:4px 0;
  border-bottom:1px solid rgba(255,255,255,0.07);
}
.clickable-item:hover {
  color:#00fff7;
  text-shadow:0 0 10px #00fff7;
}
</style>
</head>

<body>
<div class="container">
  <h1>Roblox Neon Lookup</h1>

  <div class="controls">
    <input id="rbxUser" placeholder="Roblox username (e.g. builderman)">
    <button id="rbxFetch">Fetch Profile</button>
  </div>

  <div id="rbxResults" class="grid"></div>
</div>

<!-- Popup -->
<div id="popupOverlay">
  <div class="popup-box">
    <h2 id="popupTitle"></h2>

    <!-- Search -->
    <input id="popupSearch"
      placeholder="Search..."
      style="width:100%;padding:10px;border-radius:10px;
             border:1px solid rgba(0,255,255,0.4);
             background:rgba(255,255,255,0.07);
             color:white;margin-bottom:12px;">

    <div id="popupContent"></div>

    <button onclick="closePopup()" style="margin-top:10px;">Close</button>
  </div>
</div>

<script>
// --------------------------------
// FETCH HELPERS
// --------------------------------
const proxyWrap = url => `https://corsproxy.io/?${encodeURIComponent(url)}`;

async function fetchJson(url, opts){
  const headers = opts?.method === 'POST'
    ? {'Content-Type':'application/json'}
    : {};
  const res = await fetch(url, { mode:'cors', credentials:'omit', ...opts, headers });
  if(!res.ok) throw new Error("Request failed: "+res.status);
  return await res.json();
}

// Working username lookup
const usernameEndpoints = [
  'https://users.roproxy.com/v1/usernames/users',
  'https://users.rprxy.xyz/v1/usernames/users',
  proxyWrap('https://users.roblox.com/v1/usernames/users')
];

async function lookupUser(name){
  const payload = { usernames:[name] };
  for(const url of usernameEndpoints){
    try{
      const data = await fetchJson(url, {method:'POST',body:JSON.stringify(payload)});
      if(data?.data?.length) return data.data[0];
    }catch{}
  }
  throw new Error("Unable to reach Roblox user services.");
}

// --------------------------------
// POPUP WITH SEARCH + CLICKABLE ITEMS
// --------------------------------
let popupItems = [];
let popupAction = null;

function showPopup(title, items, onClick=null){
  popupItems = items.slice();
  popupAction = onClick;

  document.getElementById("popupTitle").textContent = title;
  document.getElementById("popupOverlay").style.display = "flex";

  renderPopupList(items);

  const search = document.getElementById("popupSearch");
  search.value = "";
  search.oninput = () => {
    const q = search.value.toLowerCase();
    const filtered = popupItems.filter(x => x.toLowerCase().includes(q));
    renderPopupList(filtered);
  };
}

function renderPopupList(list){
  const box = document.getElementById("popupContent");

  if(!list.length){
    box.innerHTML = "<p>No results.</p>";
    return;
  }

  box.innerHTML = list
    .map(name => `
      <div class="clickable-item" onclick="popupItemClicked('${name}')">
        ${name}
      </div>
    `)
    .join("");
}

function popupItemClicked(name){
  if(popupAction){
    closePopup();
    popupAction(name);
  }
}

function closePopup(){
  document.getElementById("popupOverlay").style.display = "none";
}

// --------------------------------
// MAIN RENDER
// --------------------------------
document.getElementById("rbxFetch").onclick = () => {
  const user = document.getElementById("rbxUser").value.trim();
  renderRoblox(user || "builderman");
};

async function renderRoblox(username){
  const wrap = document.getElementById("rbxResults");
  wrap.innerHTML = '<div class="card"><p>Loading...</p></div>';

  try{
    const user = await lookupUser(username);
    const userId = user.id;

    // multi-fallback fetch
    async function tryMulti(sets){
      for(const set of sets){
        for(const cfg of set){
          try{ return await fetchJson(cfg.url, cfg.opts); }
          catch{}
        }
      }
      return null;
    }

    const hosts = (bases, path) =>
      bases.map(b => ({url: `${b}${path}`}));

    // Hosts
    const users = [
      'https://users.roproxy.com',
      'https://users.rprxy.xyz',
      proxyWrap('https://users.roblox.com')
    ];

    const friendsHost = [
      'https://friends.roproxy.com',
      'https://friends.rprxy.xyz',
      proxyWrap('https://friends.roblox.com')
    ];

    const groupsHost = [
      'https://groups.roproxy.com',
      'https://groups.rprxy.xyz',
      proxyWrap('https://groups.roblox.com')
    ];

    // FIXED BADGES API
    const badgesHost = [
      `https://badges.roproxy.com/v1/users/${userId}/badges?limit=100&sortOrder=Asc`,
      `https://badges.rprxy.xyz/v1/users/${userId}/badges?limit=100&sortOrder=Asc`,
      proxyWrap(`https://badges.roblox.com/v1/users/${userId}/badges?limit=100&sortOrder=Asc`)
    ];

    const avatarHost = [
      'https://avatar.roproxy.com',
      'https://avatar.rprxy.xyz',
      proxyWrap('https://avatar.roblox.com')
    ];

    const [profile,presence,friends,groups,badges,avatar] = await Promise.all([

      tryMulti([ hosts(users, `/v1/users/${userId}`) ]),

      tryMulti([[
        {url:'https://presence.roproxy.com/v1/presence/users',opts:{method:'POST',body:JSON.stringify({userIds:[userId]})}},
        {url:'https://presence.rprxy.xyz/v1/presence/users',opts:{method:'POST',body:JSON.stringify({userIds:[userId]})}},
        {url:proxyWrap('https://presence.roblox.com/v1/presence/users'),opts:{method:'POST',body:JSON.stringify({userIds:[userId]})}}
      ]]),

      tryMulti([ hosts(friendsHost, `/v1/users/${userId}/friends?limit=200`) ]),

      tryMulti([ hosts(groupsHost, `/v2/users/${userId}/groups/roles`) ]),

      // FIXED BADGES:
      tryMulti([ badgesHost.map(url => ({url})) ]),

      tryMulti([ hosts(avatarHost, `/v1/users/${userId}/avatar`) ])

    ]);

    // Presence text
    const presenceType = presence?.userPresences?.[0]?.userPresenceType;
    const presenceText =
      presenceType === 2 ? "In-Game" :
      presenceType === 1 ? "Online" :
      presenceType === 3 ? "Studio" : "Offline";

    // Data arrays
    const friendsAll = (friends?.data || []).map(f => f.name);
    const groupsAll  = (groups?.data  || []).map(g => g.group.name);
    const badgesAll  = (badges?.data  || []).map(b => b.name);

    const rap = (avatar?.assets || [])
      .reduce((s,a)=> s+(a.recentAveragePrice||0),0)
      .toLocaleString();

    wrap.innerHTML = "";

    function card(title, body, list, clickFunction=null){
      const div=document.createElement("div");
      div.className="card";
      div.innerHTML=`<h3>${title}</h3><p>${body}</p>`;
      if(list && list.length){
        const btn=document.createElement("button");
        btn.textContent="Show All";
        btn.style.marginTop="8px";
        btn.onclick=()=>showPopup(title, list, clickFunction);
        div.appendChild(btn);
      }
      wrap.appendChild(div);
    }

    // Cards
    card("Profile",
      `<strong>${profile.displayName}</strong><br>@${profile.name}<br>Created: ${
        new Date(profile.created).toLocaleDateString()
      }`
    );

    card("Presence", presenceText);

    // CLICK A FRIEND â†’ load their profile
    card("Friends",
      friendsAll.slice(0,6).join(", ") || "None",
      friendsAll,
      name => renderRoblox(name)
    );

    card("Groups",
      groupsAll.slice(0,6).join(", ") || "None",
      groupsAll
    );

    card("Badges",
      badgesAll.slice(0,6).join(", ") || "None",
      badgesAll
    );

    card("RAP", rap || "Unavailable");

  }catch(err){
    document.getElementById("rbxResults").innerHTML =
      `<div class="card"><p>${err.message}</p></div>`;
  }
}
</script>
</body>
</html>
