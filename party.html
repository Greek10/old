<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>party.web — 3D Prototype</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <style>
    html, body {
      margin: 0;
      padding: 0;
      overflow: hidden;
      height: 100%;
      background: radial-gradient(circle at top, #1a1a2e, #050509, #000);
      font-family: system-ui, sans-serif;
      color: #fff;
    }

    canvas { display: block; }

    /* Overlays */
    #startOverlay, #endingOverlay {
      position: fixed;
      inset: 0;
    }

    #startOverlayInner {
      position: absolute;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      backdrop-filter: blur(9px);
      background: rgba(0,0,0,0.6);
    }

    .card {
      background: rgba(0, 0, 0, 0.55);
      border: 1px solid rgba(255,255,255,0.1);
      padding: 25px;
      border-radius: 16px;
      box-shadow: 0 0 30px rgba(0,0,0,0.7);
      text-align: center;
      width: 360px;
    }

    .btn {
      margin-top: 15px;
      padding: 10px 20px;
      border-radius: 999px;
      background: #ff5c9a;
      color: white;
      font-weight: bold;
      border: none;
      cursor: pointer;
      font-size: 16px;
    }

    .btn:hover {
      filter: brightness(1.15);
    }

    #crosshair {
      position: absolute;
      left: 50%;
      top: 50%;
      width: 12px;
      height: 12px;
      transform: translate(-50%, -50%);
      pointer-events: none;
      opacity: 0.65;
    }

    #crosshair::before,
    #crosshair::after {
      content: "";
      position: absolute;
      background: rgba(255,255,255,0.8);
    }

    #crosshair::before {
      left: 50%; top: 0;
      width: 2px; height: 12px;
      transform: translateX(-50%);
    }

    #crosshair::after {
      top: 50%; left: 0;
      width: 12px; height: 2px;
      transform: translateY(-50%);
    }

    #hintOverlayText {
      position: absolute;
      left: 50%;
      bottom: 28px;
      transform: translateX(-50%);
      padding: 6px 12px;
      background: rgba(0,0,0,0.5);
      border-radius: 8px;
      font-size: 0.75rem;
    }

    #endingOverlayInner {
      position: absolute;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(0,0,0,0.8);
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s ease;
    }

    #endingOverlayInner.visible {
      opacity: 1;
      pointer-events: auto;
    }
  </style>
</head>
<body>

  <!-- Start Screen -->
  <div id="startOverlay">
    <div id="startOverlayInner">
      <div class="card">
        <h1><span style="color:#ff5c9a">party</span>.web</h1>
        <p>Walk to the house… or leave.</p>
        <p><strong>Controls:</strong> WASD, Mouse, Shift to sprint.</p>
        <button id="startButton" class="btn">Enter Party</button>
      </div>
    </div>
  </div>

  <!-- Crosshair -->
  <div id="crosshair"></div>

  <!-- Hint -->
  <div id="hintOverlayText">
    Find the house. Maybe the party is inside.
  </div>

  <!-- Ending Overlay -->
  <div id="endingOverlay">
    <div id="endingOverlayInner">
      <div class="card">
        <h2 id="endingCardTitle"></h2>
        <p id="endingCardSubtitle"></p>
        <p id="endingDetails"></p>
        <p style="color:#ff5c9a; margin-top:10px;">Press R to restart</p>
      </div>
    </div>
  </div>

  <!-- Scene -->
  <script type="module">

    import * as THREE from "https://unpkg.com/three@0.161.0/build/three.module.js";
    import { PointerLockControls } from "https://unpkg.com/three@0.161.0/examples/jsm/controls/PointerLockControls.js";

    /* ---------------------------
       VARIABLES / WORLD SETUP
    ----------------------------*/

    let camera, scene, renderer, controls;
    let moveForward = false, moveBackward = false, moveLeft = false, moveRight = false;
    let sprint = false;
    const velocity = new THREE.Vector3();
    const direction = new THREE.Vector3();
    const clock = new THREE.Clock();
    let ended = false;

    const startPos = new THREE.Vector3(0, 1.7, 18);
    const triggers = [];
    let tixMesh;

    /* HTML elements */
    const startOverlay = document.getElementById("startOverlay");
    const endingOverlayInner = document.getElementById("endingOverlayInner");
    const endingTitle = document.getElementById("endingCardTitle");
    const endingSubtitle = document.getElementById("endingCardSubtitle");
    const endingDetails = document.getElementById("endingDetails");
    const hintText = document.getElementById("hintOverlayText");

    init();
    animate();

    /* ---------------------------
        INITIALIZATION
    ----------------------------*/

    function init() {

      /* Create scene */
      scene = new THREE.Scene();
      scene.fog = new THREE.FogExp2(0x050509, 0.045);

      camera = new THREE.PerspectiveCamera(
        75, window.innerWidth / window.innerHeight, 0.1, 1000
      );
      camera.position.copy(startPos);

      renderer = new THREE.WebGLRenderer({ antialias:true });
      renderer.setSize(window.innerWidth, window.innerHeight);
      renderer.setPixelRatio(window.devicePixelRatio);
      renderer.setClearColor(0x050509);
      document.body.appendChild(renderer.domElement);

      /* Lights */
      scene.add(new THREE.AmbientLight(0x8888aa, 0.9));

      const moon = new THREE.DirectionalLight(0x99bbff, 0.8);
      moon.position.set(20,40,10);
      scene.add(moon);

      /* Controls */
      controls = new PointerLockControls(camera, document.body);

      document.getElementById("startButton").addEventListener("click", () => {
        startOverlay.style.display = "none";

        // slight delay fixes pointer-lock refusal
        setTimeout(() => controls.lock(), 50);
      });

      // fallback: clicking anywhere locks if not ended
      document.body.addEventListener("click", () => {
        if (!controls.isLocked && !ended) controls.lock();
      });

      /* Build scene */
      createGround();
      createHouse();
      createTrees();
      createSubject();
      createCar();
      createTix();

      setupTriggers();

      /* Key Input */
      document.addEventListener("keydown", onKeyDown);
      document.addEventListener("keyup", onKeyUp);
      window.addEventListener("resize", onResize);
    }

    /* ---------------------------
           SCENE OBJECTS
    ----------------------------*/

    function createGround() {
      const geo = new THREE.PlaneGeometry(80,80);
      const mat = new THREE.MeshStandardMaterial({ color:0x0b0f16, roughness:1 });
      const ground = new THREE.Mesh(geo,mat);
      ground.rotation.x = -Math.PI/2;
      scene.add(ground);
    }

    function createHouse() {
      const body = new THREE.Mesh(
        new THREE.BoxGeometry(16,8,16),
        new THREE.MeshStandardMaterial({color:0x141421})
      );
      body.position.set(0,4,-10);
      scene.add(body);

      const roof = new THREE.Mesh(
        new THREE.ConeGeometry(10,4,4),
        new THREE.MeshStandardMaterial({color:0x1f1b3a})
      );
      roof.position.set(0,9,-10);
      roof.rotation.y = Math.PI/4;
      scene.add(roof);

      // glowing door
      const door = new THREE.Mesh(
        new THREE.PlaneGeometry(3,4),
        new THREE.MeshBasicMaterial({color:0xff5c9a, transparent:true, opacity:0.5})
      );
      door.position.set(0,2,-2);
      scene.add(door);

      const partyLight = new THREE.PointLight(0xff99cc, 2, 18);
      partyLight.position.set(0,4,-12);
      scene.add(partyLight);
    }

    function createTrees() {
      const trunkMat = new THREE.MeshStandardMaterial({ color:0x382626 });
      const leafMat = new THREE.MeshStandardMaterial({ color:0x13281c });

      [[-10,-4],[-14,-8],[10,-3],[14,-7]].forEach(([x,z]) => {
        const trunk = new THREE.Mesh(
          new THREE.CylinderGeometry(0.4,0.7,4),
          trunkMat
        );
        trunk.position.set(x,2,z);
        scene.add(trunk);

        const leaves = new THREE.Mesh(
          new THREE.SphereGeometry(2.2),
          leafMat
        );
        leaves.position.set(x,5,z);
        scene.add(leaves);
      });
    }

    function createSubject() {
      const subject = new THREE.Mesh(
        new THREE.CapsuleGeometry(0.8,1.8),
        new THREE.MeshStandardMaterial({
          color:0xffffff,
          emissive:0xffffff,
          emissiveIntensity:0.1
        })
      );
      subject.position.set(-4,2.2,8);
      subject.userData.isSubject = true;
      scene.add(subject);
    }

    function createCar() {
      const body = new THREE.Mesh(
        new THREE.BoxGeometry(4,1,2),
        new THREE.MeshStandardMaterial({color:0x30353f})
      );
      body.position.set(0,0.6,24);
      scene.add(body);
    }

    function createTix() {
      tixMesh = new THREE.Mesh(
        new THREE.BoxGeometry(0.8,0.2,0.5),
        new THREE.MeshStandardMaterial({color:0xffd15c, emissive:0xffd15c})
      );
      tixMesh.position.set(6,0.3,10);
      scene.add(tixMesh);
    }

    /* ---------------------------
        TRIGGERS / ENDINGS
    ----------------------------*/

    function setupTriggers() {
      triggers.push({
        name:"fake_party",
        type:"volume",
        box:{min:new THREE.Vector3(-1.5,0,-1), max:new THREE.Vector3(1.5,3,-4.5)},
        once:true
      });

      triggers.push({
        name:"inside_house",
        type:"volume",
        box:{min:new THREE.Vector3(-7,0,-6), max:new THREE.Vector3(7,5,-20)},
        once:true
      });

      triggers.push({
        name:"car_refuse",
        type:"volume",
        box:{min:new THREE.Vector3(-2,0,22), max:new THREE.Vector3(2,3,27)},
        once:true
      });

      triggers.push({
        name:"tix",
        type:"tix",
        radius:1.2,
        once:true
      });
    }

    function end(id) {
      if (ended) return;
      ended = true;
      controls.unlock();

      let title="", subtitle="", details="";

      if (id==="fake_party") {
        title="Fake Party";
        subtitle="That didn’t look normal.";
        details="Something behind the walls is smiling.";
      }
      else if(id==="inside_house") {
        title="Winner";
        subtitle="You entered the party room.";
        details="But the house wasn't made for you.";
      }
      else if(id==="car_refuse") {
        title="Refusal";
        subtitle="You go home instead.";
        details="In the mirror, something stands where the house was.";
      }
      else if(id==="tix") {
        title="Tix Ending";
        subtitle="Nostalgia claimed its price.";
        details="You touched the forbidden ticket.";
      }

      endingTitle.textContent = title + " Ending";
      endingSubtitle.textContent = subtitle;
      endingDetails.textContent = details;

      endingOverlayInner.classList.add("visible");
      hintText.textContent = "Press R to restart.";
    }

    function resetGame() {
      ended = false;
      endingOverlayInner.classList.remove("visible");
      camera.position.copy(startPos);
      camera.rotation.set(0,0,0);

      hintText.textContent = "Find the house.";
    }

    /* ---------------------------
             INPUT
    ----------------------------*/

    function onKeyDown(e){
      switch(e.code){
        case "KeyW": moveForward=true; break;
        case "KeyA": moveLeft=true; break;
        case "KeyS": moveBackward=true; break;
        case "KeyD": moveRight=true; break;
        case "ShiftLeft": sprint=true; break;
        case "KeyR": if(ended) resetGame(); break;
      }
    }

    function onKeyUp(e){
      switch(e.code){
        case "KeyW": moveForward=false; break;
        case "KeyA": moveLeft=false; break;
        case "KeyS": moveBackward=false; break;
        case "KeyD": moveRight=false; break;
        case "ShiftLeft": sprint=false; break;
      }
    }

    /* ---------------------------
          TRIGGER CHECKING
    ----------------------------*/

    function checkTriggers() {
      const pos = camera.position;

      for (const trig of triggers){
        if (trig.once && trig._done) continue;

        if (trig.type==="volume"){
          if(
            pos.x>=trig.box.min.x && pos.x<=trig.box.max.x &&
            pos.y>=trig.box.min.y && pos.y<=trig.box.max.y &&
            pos.z>=trig.box.min.z && pos.z<=trig.box.max.z
          ){
            trig._done=true;
            end(trig.name);
            return;
          }
        }

        if(trig.type==="tix"){
          if (!tixMesh) continue;
          const d = pos.distanceTo(tixMesh.position);
          if(d<=trig.radius){
            trig._done=true;
            end(trig.name);
            return;
          }
        }
      }
    }

    /* ---------------------------
              RESIZE
    ----------------------------*/
    function onResize(){
      camera.aspect = window.innerWidth/window.innerHeight;
      camera.updateProjectionMatrix();
      renderer.setSize(window.innerWidth, window.innerHeight);
    }

    /* ---------------------------
              LOOP
    ----------------------------*/

    function animate(){
      requestAnimationFrame(animate);
      const delta = clock.getDelta();

      if(!ended && controls.isLocked){
        const speed = sprint ? 420 : 260;

        velocity.x -= velocity.x * 8 * delta;
        velocity.z -= velocity.z * 8 * delta;

        direction.z = Number(moveForward) - Number(moveBackward);
        direction.x = Number(moveRight) - Number(moveLeft);
        direction.normalize();

        if(moveForward || moveBackward) velocity.z -= direction.z * speed * delta;
        if(moveLeft || moveRight) velocity.x -= direction.x * speed * delta;

        controls.moveRight(-velocity.x * delta);
        controls.moveForward(-velocity.z * delta);

        camera.position.y = 1.7;

        checkTriggers();
      }

      renderer.render(scene, camera);
    }

  </script>

</body>
</html>
