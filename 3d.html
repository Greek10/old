<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Tycoon 3D</title>
  <style>
    * { box-sizing: border-box; }
    body {
      margin: 0;
      overflow: hidden;
      font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      background: radial-gradient(#0f172a, #020617);
      color: #e2e8f0;
    }
    #overlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      padding: 16px;
      display: flex;
      gap: 16px;
      align-items: flex-start;
      pointer-events: none;
      z-index: 2;
    }
    #hud {
      background: rgba(15, 23, 42, 0.65);
      border: 1px solid rgba(255, 255, 255, 0.08);
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.35);
      padding: 12px 16px;
      border-radius: 12px;
      min-width: 220px;
      pointer-events: auto;
    }
    #hud h1 {
      font-size: 20px;
      margin: 0 0 8px;
      color: #cbd5e1;
      letter-spacing: 0.5px;
    }
    .stat {
      display: flex;
      justify-content: space-between;
      margin-bottom: 6px;
      font-size: 14px;
    }
    #btns {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
      gap: 8px;
      pointer-events: auto;
    }
    button {
      background: linear-gradient(90deg, #22c55e, #16a34a);
      border: none;
      color: #0b1f15;
      font-weight: 700;
      padding: 10px 12px;
      border-radius: 10px;
      cursor: pointer;
      transition: transform 0.1s ease, box-shadow 0.2s ease;
      box-shadow: 0 6px 14px rgba(34, 197, 94, 0.35);
      text-align: left;
    }
    button:hover { transform: translateY(-2px); }
    button:disabled {
      background: #1f2937;
      color: #9ca3af;
      box-shadow: none;
      cursor: not-allowed;
    }
    #tip {
      position: absolute;
      right: 16px;
      bottom: 16px;
      background: rgba(15, 23, 42, 0.7);
      padding: 12px 16px;
      border-radius: 12px;
      border: 1px solid rgba(255, 255, 255, 0.07);
      max-width: 320px;
      line-height: 1.4;
      pointer-events: auto;
      z-index: 2;
    }
    #status {
      width: 100%;
      margin-top: 8px;
      padding: 10px 12px;
      border-radius: 10px;
      background: rgba(37, 99, 235, 0.14);
      border: 1px solid rgba(59, 130, 246, 0.35);
      color: #bfdbfe;
      font-weight: 600;
      line-height: 1.5;
    }
    #log {
      margin-top: 8px;
      font-size: 12px;
      color: #9ca3af;
      max-height: 120px;
      overflow-y: auto;
      scrollbar-width: thin;
    }
    .chip {
      display: inline-block;
      padding: 2px 8px;
      background: rgba(148, 163, 184, 0.15);
      border-radius: 999px;
      margin-right: 6px;
      font-size: 12px;
      border: 1px solid rgba(255,255,255,0.08);
    }
  </style>
</head>
<body>
  <div id="overlay">
    <div id="hud">
      <h1>Neo Tycoon</h1>
      <div class="stat"><span>Cash</span><span id="cash">$0</span></div>
      <div class="stat"><span>Income / sec</span><span id="income">$0</span></div>
      <div class="stat"><span>Upgrades</span><span id="owned">0</span></div>
      <div class="stat"><span>Crates Grabbed</span><span id="crates">0</span></div>
      <div id="status">Spinning up tycoon session...</div>
      <div id="log"></div>
    </div>
    <div id="btns"></div>
  </div>
  <div id="tip">
    <div class="chip">WASD to move</div>
    <div class="chip">Space to hop</div>
    <div class="chip">Hold Shift to sprint</div>
    <p style="margin:8px 0 0;">Collect shimmering crates to gain instant cash. Upgrades build parts of your factory in real time.</p>
  </div>

  <script type="module">
    import * as THREE from 'https://unpkg.com/three@0.155.0/build/three.module.js';
    import { PointerLockControls } from 'https://unpkg.com/three@0.155.0/examples/jsm/controls/PointerLockControls.js';
    import { OrbitControls } from 'https://unpkg.com/three@0.155.0/examples/jsm/controls/OrbitControls.js';

    const scene = new THREE.Scene();
    scene.background = new THREE.Color('#0f172a');

    const camera = new THREE.PerspectiveCamera(65, window.innerWidth / window.innerHeight, 0.1, 2000);
    camera.position.set(0, 4, 16);

    const renderer = new THREE.WebGLRenderer({ antialias: true });
    renderer.setSize(window.innerWidth, window.innerHeight);
    renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
    renderer.shadowMap.enabled = true;
    document.body.appendChild(renderer.domElement);

    const orbit = new OrbitControls(camera, renderer.domElement);
    orbit.enableDamping = true;
    orbit.target.set(0, 2, 0);

    const controls = new PointerLockControls(camera, document.body);
    const statusEl = document.getElementById('status');
    let playing = true;
    orbit.enabled = false;
    renderer.domElement.addEventListener('click', () => {
      if (!controls.isLocked) controls.lock();
    });

    controls.addEventListener('lock', () => {
      statusEl.textContent = 'Pointer locked – press ESC to release.';
    });
    controls.addEventListener('unlock', () => {
      statusEl.textContent = 'Playing without mouse lock – use arrows to look (click to re-lock).';
    });

    // Lighting
    const hemi = new THREE.HemisphereLight(0x9ad7ff, 0x111322, 1.1);
    scene.add(hemi);

    const sun = new THREE.DirectionalLight(0xffffff, 1.2);
    sun.position.set(12, 25, 8);
    sun.castShadow = true;
    sun.shadow.mapSize.set(2048, 2048);
    scene.add(sun);

    // Ground
    const groundGeo = new THREE.PlaneGeometry(200, 200);
    const groundMat = new THREE.MeshStandardMaterial({ color: 0x0b1220, roughness: 0.9, metalness: 0.05 });
    const ground = new THREE.Mesh(groundGeo, groundMat);
    ground.rotation.x = -Math.PI / 2;
    ground.receiveShadow = true;
    scene.add(ground);

    const grid = new THREE.GridHelper(200, 60, '#1f2937', '#111827');
    grid.position.y = 0.02;
    scene.add(grid);

    // Base platform
    const base = new THREE.Group();
    scene.add(base);

    const baseFloor = new THREE.Mesh(
      new THREE.BoxGeometry(20, 1, 20),
      new THREE.MeshStandardMaterial({ color: 0x1d4ed8, roughness: 0.5 })
    );
    baseFloor.position.y = 0.5;
    baseFloor.castShadow = true;
    baseFloor.receiveShadow = true;
    base.add(baseFloor);

    // Conveyor line
    const conveyor = new THREE.Mesh(
      new THREE.BoxGeometry(14, 0.4, 3),
      new THREE.MeshStandardMaterial({ color: 0x111827, metalness: 0.3, roughness: 0.4 })
    );
    conveyor.position.set(0, 1.2, 0);
    conveyor.castShadow = true;
    conveyor.receiveShadow = true;
    base.add(conveyor);

    const collector = new THREE.Mesh(
      new THREE.BoxGeometry(2.2, 1.6, 3.4),
      new THREE.MeshStandardMaterial({
        color: 0x0ea5e9,
        emissive: 0x22d3ee,
        emissiveIntensity: 0.5,
        metalness: 0.3,
        roughness: 0.3,
        transparent: true,
        opacity: 0.4,
      })
    );
    collector.position.set(7.5, 1.8, 0);
    collector.castShadow = true;
    base.add(collector);

    const collectorHalo = new THREE.Mesh(
      new THREE.CylinderGeometry(1.2, 1.2, 0.2, 24),
      new THREE.MeshStandardMaterial({ color: 0x22c55e, emissive: 0x22c55e, emissiveIntensity: 0.4, transparent: true, opacity: 0.5 })
    );
    collectorHalo.position.set(7.5, 1.1, 0);
    collectorHalo.rotation.x = Math.PI / 2;
    base.add(collectorHalo);

    const beltGlow = new THREE.Mesh(
      new THREE.BoxGeometry(14.1, 0.05, 0.6),
      new THREE.MeshStandardMaterial({ color: 0x22c55e, emissive: 0x22c55e, emissiveIntensity: 0.3 })
    );
    beltGlow.position.set(0, 1.45, 0);
    base.add(beltGlow);

    // Spawn point marker
    const spawnMarker = new THREE.Mesh(
      new THREE.CylinderGeometry(0.8, 0.8, 0.2, 24),
      new THREE.MeshStandardMaterial({ color: 0x22c55e, emissive: 0x22c55e, emissiveIntensity: 0.4 })
    );
    spawnMarker.position.set(-6, 1.2, 0);
    spawnMarker.rotateX(Math.PI / 2);
    base.add(spawnMarker);

    // Decorative holo pillar
    const holoMat = new THREE.MeshStandardMaterial({ color: 0x38bdf8, transparent: true, opacity: 0.35, emissive: 0x38bdf8, emissiveIntensity: 0.7 });
    const holoPillar = new THREE.Mesh(new THREE.CylinderGeometry(0.6, 0.6, 6, 20), holoMat);
    holoPillar.position.set(6, 3, -6);
    base.add(holoPillar);

    // Starter dropper so the conveyor is alive immediately
    const starterDropper = new THREE.Group();
    const starterBody = new THREE.Mesh(
      new THREE.BoxGeometry(1.4, 1.4, 1.4),
      new THREE.MeshStandardMaterial({ color: 0x06b6d4, metalness: 0.35, roughness: 0.5 })
    );
    starterBody.position.y = 0.7;
    const starterEmitter = new THREE.Mesh(
      new THREE.CylinderGeometry(0.45, 0.45, 0.4, 18),
      new THREE.MeshStandardMaterial({ color: 0x22c55e, emissive: 0x22c55e, emissiveIntensity: 0.7 })
    );
    starterEmitter.position.y = 1.3;
    starterDropper.add(starterBody);
    starterDropper.add(starterEmitter);
    starterDropper.position.set(-6, 1.2, 0);
    base.add(starterDropper);

    // State
    let cash = 0;
    let cratesCollected = 0;
    let incomePerSecond = 6;
    let ownedUpgrades = 0;
    let conveyorBoxes = [];
    let cratePickups = [];

    const logEl = document.getElementById('log');
    const cashEl = document.getElementById('cash');
    const incomeEl = document.getElementById('income');
    const ownedEl = document.getElementById('owned');
    const cratesEl = document.getElementById('crates');

    function log(text) {
      const line = document.createElement('div');
      line.textContent = text;
      logEl.prepend(line);
      while (logEl.childElementCount > 5) logEl.removeChild(logEl.lastChild);
    }

    function formatCash(v) {
      return `$${Math.floor(v).toLocaleString()}`;
    }

    // UI buttons
    const upgradeData = [
      { id: 'dropper1', name: 'Starter Dropper', cost: 60, description: '+6 cash/sec & installs a small dropper', action: addDropperSmall },
      { id: 'dropper2', name: 'Mega Dropper', cost: 160, description: '+14 cash/sec & spawns a mega dropper', action: addDropperMega },
      { id: 'scanner', name: 'Value Scanner', cost: 120, description: 'Boost conveyor crate value by +35%', action: addScanner },
      { id: 'walls', name: 'Force Walls', cost: 110, description: 'Raise protective walls around your plot', action: addWalls },
      { id: 'decor', name: 'Neon Garden', cost: 90, description: 'Adds neon shrubs & light pools', action: addGarden },
      { id: 'orb', name: 'Sky Beacon', cost: 200, description: 'Beacon doubles your passive income', action: addBeacon },
    ];

    const btnContainer = document.getElementById('btns');
    const buttons = new Map();

    upgradeData.forEach(up => {
      const btn = document.createElement('button');
      btn.innerHTML = `<strong>${up.name}</strong><br><small>${up.description}</small><br><strong>Cost: $${up.cost}</strong>`;
      btn.addEventListener('click', () => purchase(up));
      btnContainer.appendChild(btn);
      buttons.set(up.id, btn);
    });

    function purchase(upgrade) {
      if (cash < upgrade.cost) {
        log(`Not enough cash for ${upgrade.name}`);
        return;
      }
      const btn = buttons.get(upgrade.id);
      if (btn.disabled) return;
      cash -= upgrade.cost;
      upgrade.action();
      btn.disabled = true;
      btn.textContent = `${upgrade.name} purchased`;
      ownedUpgrades++;
      log(`${upgrade.name} built!`);
    }

    // Upgrades
    function addDropperSmall() {
      incomePerSecond += 6;
      const body = new THREE.Mesh(new THREE.BoxGeometry(1.3, 1, 1.3), new THREE.MeshStandardMaterial({ color: 0x22c55e, metalness: 0.3 }));
      body.position.set(-4, 1.8, -1);
      body.castShadow = true;
      base.add(body);
      spawnDropParticles(body.position);
    }

    function addDropperMega() {
      incomePerSecond += 14;
      const body = new THREE.Mesh(new THREE.BoxGeometry(1.6, 1.6, 1.6), new THREE.MeshStandardMaterial({ color: 0xfbbf24, metalness: 0.35 }));
      body.position.set(4, 2.2, -1);
      body.castShadow = true;
      base.add(body);
      const head = new THREE.Mesh(new THREE.CylinderGeometry(0.6, 0.6, 0.4, 20), new THREE.MeshStandardMaterial({ color: 0xf59e0b, emissive: 0xf59e0b, emissiveIntensity: 0.6 }));
      head.position.set(4, 2.8, -1);
      head.castShadow = true;
      base.add(head);
      spawnDropParticles(body.position);
    }

    let scannerBoost = 1;
    function addScanner() {
      scannerBoost = 1.35;
      const arch = new THREE.Mesh(new THREE.BoxGeometry(1.6, 2.2, 0.3), new THREE.MeshStandardMaterial({ color: 0x60a5fa, emissive: 0x60a5fa, emissiveIntensity: 0.4 }));
      arch.position.set(0, 2.2, 0);
      arch.castShadow = true;
      base.add(arch);
    }

    function addWalls() {
      const mat = new THREE.MeshStandardMaterial({ color: 0x0ea5e9, transparent: true, opacity: 0.4, emissive: 0x0ea5e9, emissiveIntensity: 0.3 });
      const positions = [
        [0, 2.5, -10.5, 20, 5, 1],
        [0, 2.5, 10.5, 20, 5, 1],
        [-10.5, 2.5, 0, 1, 5, 20],
        [10.5, 2.5, 0, 1, 5, 20],
      ];
      positions.forEach(([x, y, z, w, h, d]) => {
        const wall = new THREE.Mesh(new THREE.BoxGeometry(w, h, d), mat);
        wall.position.set(x, y, z);
        wall.receiveShadow = true;
        base.add(wall);
      });
    }

    function addGarden() {
      const mat = new THREE.MeshStandardMaterial({ color: 0x22d3ee, emissive: 0x0ea5e9, emissiveIntensity: 0.4, transparent: true, opacity: 0.65 });
      for (let i = 0; i < 6; i++) {
        const ring = new THREE.Mesh(new THREE.TorusGeometry(0.6, 0.18, 12, 30), mat);
        ring.position.set(-6 + Math.random() * 12, 0.8, -6 + Math.random() * 12);
        ring.rotation.x = Math.PI / 2;
        base.add(ring);
      }
      const lamp = new THREE.PointLight(0x22d3ee, 1.2, 12);
      lamp.position.set(0, 4, 6);
      base.add(lamp);
    }

    function addBeacon() {
      incomePerSecond *= 2;
      const sphere = new THREE.Mesh(new THREE.SphereGeometry(1.2, 32, 32), new THREE.MeshStandardMaterial({ color: 0x818cf8, emissive: 0x6366f1, emissiveIntensity: 0.8, transparent: true, opacity: 0.7 }));
      sphere.position.set(0, 6, 0);
      base.add(sphere);
      const beam = new THREE.Mesh(new THREE.CylinderGeometry(0.5, 0.5, 12, 16), new THREE.MeshStandardMaterial({ color: 0x6366f1, transparent: true, opacity: 0.35, emissive: 0x818cf8, emissiveIntensity: 1 }));
      beam.position.set(0, 6, 0);
      base.add(beam);
    }

    // Conveyor crates
    function createCrate(color = 0x22c55e) {
      const crate = new THREE.Mesh(new THREE.BoxGeometry(0.8, 0.8, 0.8), new THREE.MeshStandardMaterial({ color, metalness: 0.2, roughness: 0.5 }));
      crate.position.set(-6, 1.8, 0);
      crate.castShadow = true;
      crate.receiveShadow = true;
      base.add(crate);
      return crate;
    }

    let dropParticles = [];
    function spawnDropParticles(position) {
      const geo = new THREE.SphereGeometry(0.08, 10, 10);
      const mat = new THREE.MeshStandardMaterial({ color: 0x22c55e, emissive: 0x22c55e, emissiveIntensity: 0.8, transparent: true });
      for (let i = 0; i < 10; i++) {
        const p = new THREE.Mesh(geo, mat.clone());
        p.position.copy(position).add(new THREE.Vector3((Math.random() - 0.5) * 1.2, Math.random() * 1.2, (Math.random() - 0.5) * 1.2));
        p.userData.life = 0.8 + Math.random() * 0.6;
        p.userData.vel = new THREE.Vector3((Math.random() - 0.5) * 0.5, 0.5 + Math.random() * 0.5, (Math.random() - 0.5) * 0.5);
        dropParticles.push(p);
        base.add(p);
      }
    }

    // Pickups
    const pickupGeo = new THREE.BoxGeometry(1, 1, 1);
    const pickupMat = new THREE.MeshStandardMaterial({ color: 0xa855f7, emissive: 0xa855f7, emissiveIntensity: 0.6, transparent: true, opacity: 0.8 });
    function spawnPickups() {
      for (let i = 0; i < 4; i++) {
        const box = new THREE.Mesh(pickupGeo, pickupMat.clone());
        box.position.set(-12 + Math.random() * 24, 1.5, -12 + Math.random() * 24);
        box.castShadow = true;
        box.userData.rot = Math.random() * Math.PI * 2;
        cratePickups.push(box);
        base.add(box);
      }
    }
    spawnPickups();

    function startSession() {
      playing = true;
      orbit.enabled = false;
      cash = 120;
      incomePerSecond = Math.max(incomePerSecond, 6);
      ownedUpgrades = 0;
      cratesCollected = 0;
      cashEl.textContent = formatCash(cash);
      incomeEl.textContent = formatCash(incomePerSecond);
      ownedEl.textContent = ownedUpgrades;
      cratesEl.textContent = cratesCollected;
      statusEl.textContent = 'Session live – WASD/Space to move, arrows to look. Click to lock mouse if you want mouse-look.';
      log('Tycoon session started. Conveyor and pickups are active; spend your starting cash on upgrades to expand.');
    }

    // Movement
    const velocity = new THREE.Vector3();
    const direction = new THREE.Vector3();
    const keyState = {};
    const lookState = { ArrowUp: false, ArrowDown: false, ArrowLeft: false, ArrowRight: false };
    document.addEventListener('keydown', e => {
      keyState[e.code] = true;
      if (e.code in lookState) {
        lookState[e.code] = true;
        e.preventDefault();
      }
    });
    document.addEventListener('keyup', e => {
      keyState[e.code] = false;
      if (e.code in lookState) lookState[e.code] = false;
    });

    const playerHeight = 2;
    controls.getObject().position.set(-8, playerHeight, 8);
    scene.add(controls.getObject());

    let canJump = false;
    function applyArrowLook(delta) {
      if (!playing) return;
      const lookSpeed = 1.8;
      const yawObject = controls.getObject();

      if (lookState.ArrowLeft) yawObject.rotation.y += lookSpeed * delta;
      if (lookState.ArrowRight) yawObject.rotation.y -= lookSpeed * delta;

      let pitch = camera.rotation.x;
      if (lookState.ArrowUp) pitch += lookSpeed * delta;
      if (lookState.ArrowDown) pitch -= lookSpeed * delta;
      pitch = Math.max(-Math.PI / 2 + 0.1, Math.min(Math.PI / 2 - 0.1, pitch));
      camera.rotation.x = pitch;
    }

    function processMovement(delta) {
      if (!playing) return;
      const speed = keyState['ShiftLeft'] ? 16 : 10;
      direction.set(0, 0, 0);
      if (keyState['KeyW']) direction.z -= 1;
      if (keyState['KeyS']) direction.z += 1;
      if (keyState['KeyA']) direction.x -= 1;
      if (keyState['KeyD']) direction.x += 1;
      direction.normalize();

      velocity.x -= velocity.x * 10.0 * delta;
      velocity.z -= velocity.z * 10.0 * delta;
      velocity.y -= 30 * delta; // gravity

      if (keyState['Space'] && canJump) {
        velocity.y = 10;
        canJump = false;
      }

      if (direction.lengthSq() > 0) {
        const forward = new THREE.Vector3();
        controls.getDirection(forward);
        forward.y = 0;
        forward.normalize();
        const right = new THREE.Vector3().crossVectors(forward, new THREE.Vector3(0, 1, 0)).normalize();
        velocity.addScaledVector(forward, direction.z * speed * delta);
        velocity.addScaledVector(right, -direction.x * speed * delta);
      }

      controls.moveRight(-velocity.x * delta);
      controls.moveForward(-velocity.z * delta);
      const position = controls.getObject().position;
      position.y += velocity.y * delta;
      if (position.y < playerHeight) {
        velocity.y = 0;
        position.y = playerHeight;
        canJump = true;
      }
    }

    // Economy and updates
    let time = 0;
    let crateTimer = 0;
    function tick(delta) {
      time += delta;
      cash += incomePerSecond * delta;
      cashEl.textContent = formatCash(cash);
      incomeEl.textContent = formatCash(incomePerSecond);
      ownedEl.textContent = ownedUpgrades;
      cratesEl.textContent = cratesCollected;

      // Conveyor flow
      crateTimer += delta;
      if (crateTimer > 1.5) {
        conveyorBoxes.push(createCrate(Math.random() > 0.8 ? 0x22d3ee : 0x22c55e));
        crateTimer = 0;
      }
      conveyorBoxes = conveyorBoxes.filter(crate => {
        crate.position.x += 2.5 * delta;
        if (crate.position.x > 7.3) {
          cash += 2 * scannerBoost;
          spawnDropParticles(new THREE.Vector3(7.5, 1.6, 0));
          base.remove(crate);
          return false;
        }
        return true;
      });

      // Pickup animation & detection
      cratePickups.forEach(p => {
        p.rotation.y += delta;
        p.position.y = 1.5 + Math.sin(time * 2 + p.userData.rot) * 0.2;
        const playerPos = controls.getObject().position;
        if (playerPos.distanceTo(p.position) < 1.6) {
          cash += 45;
          cratesCollected++;
          log('Collected a neon crate (+$45)');
          base.remove(p);
          p.userData.collected = true;
        }
      });
      cratePickups = cratePickups.filter(p => !p.userData.collected);
      if (cratePickups.length < 2) spawnPickups();

      // Drop particles
      dropParticles.forEach(p => {
        p.userData.life -= delta;
        p.position.addScaledVector(p.userData.vel, delta * 3);
        p.material.opacity = Math.max(0, p.userData.life);
        if (p.userData.life <= 0) {
          base.remove(p);
          p.userData.dead = true;
        }
      });
      dropParticles = dropParticles.filter(p => !p.userData.dead);
    }

    startSession();

    // Animation
    const clock = new THREE.Clock();
    function animate() {
      const delta = Math.min(0.05, clock.getDelta());
      applyArrowLook(delta);
      processMovement(delta);
      tick(delta);
      orbit.update();
      renderer.render(scene, camera);
      requestAnimationFrame(animate);
    }
    animate();

    // window resize
    window.addEventListener('resize', () => {
      camera.aspect = window.innerWidth / window.innerHeight;
      camera.updateProjectionMatrix();
      renderer.setSize(window.innerWidth, window.innerHeight);
    });

  </script>
</body>
</html>
